<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Timed Moving Bubbles</title>
<link rel="stylesheet" href="style/style.css" type="text/css" media="screen" />
<link rel="stylesheet" href="style/dropdown.css" type="text/css" media="screen" />

</head>

<div id="main-wrapper">

	
	<div id="sidebar">
<div id="test">testint</div>
<div id="current_date">07/02/2020</div>
<div id="current_time">time</div>
<div align="center">Current Online Users:</div>
<div id="current_users" align="center">Elite: <span id = "elite">0</span> Member: <span id = "member">0</span> Eshopper: <span id="eshopper">0</span> Anonymous: <span id="anonymous">0</span></div>
<div id="current_total_users" align="center">Total: 0</div>
<div class="container">
    <span class="choose">Select Member Types: </span>
  
    <div class="dropdown">
        <div class="select">
          <span id = "selected">Select Member Types </span><span id="right_arrow">â–¼</span>
       
        </div>
        <input type="hidden" name="gender" id="list_input">
        <ul class="dropdown-menu" id="list">
		 <li id="all">All</li>
          <li id="p_personal_care">p_Personal Care</li>
          <li id="p_skincare">p_Skincare</li>
		  <li id="p_cosmetics">p_Cosmetics</li>
		  <li id="p_body_hair_care">p_Boday Hair Care</li>
		  <li id="p_sport">p_Sport</li>
		  <li id="p_men">p_Men</li>
		  <li id="p_other">p_Other</li>
		  <li id="p_derma">p_Derma</li>
		  <li id="p_watsons_brand">p_Watsons Brand</li>
		  <li id="p_bulk_buy">p_Bulk Buy</li>
		  <li id="b_personal_care">b_Personal Care</li>
          <li id="b_skincare">b_Skincare</li>
		  <li id="b_cosmetics">b_Cosmetics</li>
		  <li id="b_body_hair_care">b_Boday Hair Care</li>
		  <li id="b_sport">b_Sport</li>
		  <li id="b_men">b_Men</li>
		  <li id="b_other">b_Other</li>
		  <li id="b_derma">b_Derma</li>
		  <li id="b_watsons_brand">b_Watsons Brand</li>
		  <li id="b_bulk_buy">b_Bulk Buy</li>
        </ul>
	
      </div>

  <span class="msg"></span>
</div>
<div id="speed">
<div class="togglebutton pause" data-val="pause">Pause</div>
<div class="togglebutton medium current" data-val="medium">Slow</div>
<div class="togglebutton fast" data-val="fast">Fast</div>



<div class="clr"></div>
</div>
<div id="note"></div>
</div>
	
    <div id="chart"></div>


</div><!-- @end #main-wrapper -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="js/d3-3-5-5.min.js"></script>


<script>


/*Dropdown Menu*/
$('.dropdown').click(function () {
        $(this).attr('tabindex', 1).focus();
        $(this).toggleClass('active');
        $(this).find('.dropdown-menu').slideToggle(300);
    });
    $('.dropdown').focusout(function () {
        $(this).removeClass('active');
        $(this).find('.dropdown-menu').slideUp(300);
    });
    $('.dropdown .dropdown-menu li').click(function () {
        $(this).parents('.dropdown').find('#selected').text($(this).text());
        $(this).parents('.dropdown').find('input').attr('value', $(this).attr('id'));
    });
/*End Dropdown Menu*/

var temp;
$('.dropdown-menu li').click(function () {
  var input = '<strong>' + $(this).parents('.dropdown').find('input').val() + '</strong>',
  temp = $(this).parents('.dropdown').find('input').val();
      msg = '<span class="msg">Hidden input value: ';
  $('.msg').html(msg + input + '</span>');
  console.log(document.getElementById("list_input").value)
 
}); 



const people = {};
var USER_SPEED = "medium";

//var speeds = { "slow": 1200, "medium": 400, "fast": 100 };
var speeds = { "slow": 1200, "medium": 400, "fast": 50 };
var simtimer;

var curr_date;

var margin = {top: 70, right: 60, bottom: 70, left: 60};
margin.left = margin.right = width < 500 ? 30 : 70;
var width = parseInt(d3.select("#chart").style('width'), 10) - margin.left - margin.right,
    height = 900 - margin.top - margin.bottom,
	padding = 2,
    maxRadius = width < 500 ? 2 : 4;

	// color = d3.scale.category10();

var x = d3.scale.linear()
    .domain([1, 3])
    .range([0, width]);
	
var y = d3.scale.linear()
    .domain([1, 4])
    .range([0, height]);
	
var	sched_objs = {},
// var sched_objs = [],
//	curr_minute = 0;
	curr_minute = 79200;

//const svg = d3.select("#chart").append("svg")
//    .attr("width", width + margin.left + margin.right)
const svg = d3.select("#chart").append("svg")
	.attr("width", 1000)		
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.select("#chart").style("width", (width+margin.left+margin.right)+"px");



// Legends
 svg.append("circle")
// svg.append("circle")
	.attr("cx", 50)
	.attr("cy", -30)
	.attr("r", 10)
	.attr("fill", "#FF839A");
	
		svg.append("text")
//	svg.append("text")
		.attr("x", 65)
		.attr("y", -25)
		.text(": Elite")
		.attr("font-family", "sans-serif")
		.attr("font-size", "15px");
	svg.append("circle")	
// svg.append("circle")
	.attr("cx", 150)
	.attr("cy", -30)
	.attr("r", 10)
	.attr("fill", "#83FFEE");
	
	svg.append("text")
//	svg.append("text")
		.attr("x", 165)
		.attr("y", -25)
		.text(": Member")
		.attr("font-family", "sans-serif")
		.attr("font-size", "15px");
		
	svg.append("circle")	
//svg.append("circle")
	.attr("cx", 280)
	.attr("cy", -30)
	.attr("r", 10)
	.attr("fill", "#FDFF83");
	
	svg.append("text")	
//	svg.append("text")
		.attr("x", 295)
		.attr("y", -25)
		.text(": Eshopper")
		.attr("font-family", "sans-serif")
		.attr("font-size", "15px");
		
svg.append("circle")		
//svg.append("circle")
	.attr("cx", 400)
	.attr("cy", -30)
	.attr("r", 10)
	.attr("fill", "#ECECEC");
	
	svg.append("text")	
//	svg.append("text")
		.attr("x", 415)
		.attr("y", -25)
		.text(": Anonymous")
		.attr("font-family", "sans-serif")
		.attr("font-size", "15px");

		
//Append circle 



const groups = {
	
	"Homepage": { x: 480, y: 60, cnt: 0, fullname: "Homepage" },
	"Product": { x: 220, y: 340, cnt: 0, fullname: "Product" },
	"Other": { x: 780, y: 470, cnt: 0, fullname: "Other" },
	"Category": { x: 330, y: 100, cnt: 0, fullname: "Category" },
	"BlogContent": { x: 820, y: 340, cnt: 0, fullname: "Blog Content" },
	"Cart": { x: 290, y: 470, cnt: 0, fullname: "Cart" },
	"Checkout": {  x: 460, y: 540, cnt: 0, fullname: "Checkout" },
	"Loyalty": { x: 810, y: 210, cnt: 0, fullname: "Loyalty" },
	"MyAccount": { x: 750, y: 120, cnt: 0, fullname: "My Account" },
	"Register": { x: 640, y: 60, cnt: 0, fullname: "Register" },
	"SearchResult": { x: 210, y: 200, cnt: 0, fullname: "Search Result" },
	"Left" : { x: 380, y: 20000, cnt: 0, fullname: "Left" },
	"NULL" : { x: 640, y: 540, cnt: 0, fullname: "Order Placed" }
	
};

const member_tiers = {

	"Elite": { color: "#FF839A", cnt: 0 },
	"anonymous": { color: "#ECECEC", cnt: 0 },
	"Member": {color: "#83FFEE", cnt: 0},
	"eshopper": {color: "#FDFF83", cnt: 0}

};

var layer1 = svg.append('g');
var layer2 = svg.append('g');


// Load data.


//d3.csv("data/Page_Duration.csv", function(error, data) {	

//d3.csv("data/data_channels.csv", function(error, data) {	
d3.csv("data/Book1.csv", function(error, data) {	
//d3.csv("data/new_test.csv", function(error, data) {	
//d3.csv("data/test2.csv", function(error, data) {	
//d3.csv("data/new_dataset.csv", function(error, data) {	

/*	data.forEach(function(d) {
	
		var activities = [];
		console.log(d)
		console.log(d.pagetype)
		activities.push({'act': d.pagetype, 'duration': d.page_duration, 'tier': d.member_tier});
		sched_objs.push(activities);
	}); */
	console.log(data)
	var count = 0;
	

	
	data.forEach(d => {
//	console.log(d)
//	count+=1;
		if (d3.keys(sched_objs).includes(d.sessionid+"")) {
//        if (d3.keys(sched_objs).includes(d.userid+"")) {
//		console.log(d.userid)
//            sched_objs[d.userid+""].push({'userid': d.userid, 'act': d.pagetype, 'duration': d.page_duration, 'member_tier': d.member_tier, 'start_time': d.start_time});
			sched_objs[d.sessionid+""].push({'userid': d.sessionid,
											'act': d.pagetype, 
											'duration': d.page_duration, 
											'member_tier': d.member_tier, 
											'start_time': /*d.tstamp*/d.session_start_time,
											'p_personal_care': d.p_personal_care,
											'p_skincare': d.p_skincare,
										/*	'p_cosmetics': d.p_cosmetics,
											'p_health_care': d.p_health_care,
											'p_body_hair_care': d.p_body_hair_care,
											'p_sport': d.p_sport,
											'p_men': d.p_men,
											'p_other': d.p_other,
											'p_derma': d.p_derma,
											'p_watsons_brand': d.p_watsons_brand,
											'p_bulk_buy': d.p_bulk_buy,
											'b_personal_care': d.b_personal_care,
											'b_skincare': d.b_skincare,
											'b_cosmetics': d.b_cosmetics,
											'b_health_care': d.b_health_care,
											'b_body_hair_care': d.b_body_hair_care,
											'b_sport': d.b_sport,
											'b_men': d.b_men,
											'b_other': d.b_other,
											'b_derma': d.b_derma,
											'b_watsons_brand': d.b_watsons_brand,
											'b_bulk_buy': d.b_bulk_buy,*/
											});
        } else {
//            sched_objs[d.userid+""] = [{'userid': d.userid, 'act': d.pagetype, 'duration': d.page_duration, 'member_tier': d.member_tier, 'start_time': d.start_time}];
			sched_objs[d.sessionid+""] = [{'userid': d.sessionid,
											'act': d.pagetype, 
											'duration': Math.floor(d.page_duration), 
											'member_tier': d.member_tier, 
											'start_time': /*d.tstamp*/d.session_start_time,
											'p_personal_care': d.p_personal_care,
											'p_skincare': d.p_skincare,
										/*	'p_cosmetics': p_cosmetics,
											'p_health_care': d.p_health_care,
											'p_body_hair_care': d.p_body_hair_care,
											'p_sport': d.p_sport,
											'p_men': d.p_men,
											'p_other': d.p_other,
											'p_derma': d.p_derma,
											'p_watsons_brand': d.p_watsons_brand,
											'p_bulk_buy': d.p_bulk_buy,
											'b_personal_care': d.b_personal_care,
											'b_skincare': d.b_skincare,
											'b_cosmetics': b_cosmetics,
											'b_health_care': d.b_health_care,
											'b_body_hair_care': d.b_body_hair_care,
											'b_sport': d.b_sport,
											'b_men': d.b_men,
											'b_other': d.b_other,
											'b_derma': d.b_derma,
											'b_watsons_brand': d.b_watsons_brand,
											'b_bulk_buy': d.b_bulk_buy,	*/										
											}];
        }
    });
	


/*	var nodes = sched_objs.map(function(o,i) {
//		console.log("test");
		console.log(o[0].userid,o[0].start_time, o[0].duration);
	
		var act = o[0].act;
		var init_time = o[0].start_time;
	
		var init_x = groups[act].x + Math.random();
		var init_y = groups[act].y + Math.random();
		var col = member_tiers[o[0].member_tier].color;

	//	groups[act].cnt += 1;
		
		return {
			userid: o[0].userid,
			act: act,
			radius: maxRadius,
			x: init_x,
			y: init_y,
			color: col, //color(act),
			moves: 0,
			next_move_time: parseInt(o[0].duration),
			sched: o,		
			stroke: "black",
			start_time: init_time
		}
	});*/
	
	var nodes = [];
	
	console.log(Object.keys(sched_objs).length)
	console.log(sched_objs);
	
	for (var k in sched_objs){
//		console.log(k)
		d = sched_objs[k];
//		console.log(d[0].userid,d[0].start_time, d[0].duration);
		console.log(k)
	
		var act = d[0].act;
		var init_time = d[0].start_time;
	
		var init_x = groups[act].x + Math.random();
		var init_y = groups[act].y + Math.random();
		var col = member_tiers[d[0].member_tier].color;
	
	//	groups[act].cnt += 1;
		
		nodes.push({
			userid: d[0].userid,
			act: act,
			radius: maxRadius,
			x: init_x,
			y: init_y,
			color: col, //color(act),
			moves: 0,
			next_move_time: parseInt(d[0].duration) + curr_minute,
			sched: d,		
			stroke: "blue",
			start_time: init_time,
			leave: 0,
			exist: 0,
			member_tier: d[0].member_tier,
			p_personal_care: d[0].p_personal_care,
			p_skincare: d[0].p_skincare
		})
	
	}
	
	
	var curr_nodes = [];

	
//	console.log(data)
	nodes.forEach(d => {
//		console.log(d.sched[0].start_time)
		console.log(d.userid)

      if (d.sched[0].start_time == data[0]./*tstamp*/session_start_time) {
			
			d.exist = 1;
			d.leave = -1;
			if (d.act == "Other")
			{
			//console.log(d.sched[1])
				try{d.act = d.sched[1].act;}
				catch(err){}
			}
			curr_nodes.push(d);
				
//				console.log(d);
			if (d.color != "transparent")
			{
				groups[d.act].cnt += 1;
				member_tiers[d.member_tier].cnt += 1;
				d.stroke = "green";
			}
//			nodes.pop(d);
        } 

    });
	console.log(nodes);
//	console.log(member_tiers.eshopper.cnt);
//	curr_nodes = nodes.filter(function(d){ return d.sched[0].start_time == data[0].start_time } );
//	curr_nodes = nodes.filter(function(d){ return d.sched[0].start_time == data[0].tstamp } );
/*	curr_nodes.forEach(d => {
		groups[d.act].cnt += 1;
	}
	);*/
	
	
	//curr_nodes = nodes.filter(d => d.sched[0].start_time == data[0].start_time);
//	console.log(nodes.length)
//	curr_nodes = nodes

	console.log(curr_nodes)

	// Activity group labels
 /*   var actlabel = svg.selectAll("text")
        .data(d3.keys(groups))
      .enter().append("text")
        .attr("class", "actlabel")
        .attr("text-anchor", "middle")
          .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y)
		.attr("dy", "-1.8em")
        .text(d => groups[d].fullname);*/


	
	var force = d3.layout.force()
		.nodes(curr_nodes)
		// .links([])
		.size([width, height])
		.gravity(0)
		.charge(0.2)
		.friction(.8)
		.on("tick", tick)
		.start();
/*
	var circle = svg.append("g")		
				.attr("id", "circle_node")
				.selectAll(".node")
//	var circle = svg.selectAll(".node")
				.data(curr_nodes)
			  .enter().append("circle")
				.attr("r", function(d) { return d.radius; })

		.style("fill", function(d) { return d.color; })
		.style("stroke", function(d) { return d.stroke; });
	//	 .call(force.drag); 
*/

		var circle = layer1		
				.attr("id", "circle_node")
				.selectAll(".node")
//	var circle = svg.selectAll(".node")
				.data(curr_nodes)
			  .enter().append("circle")
				.attr("r", function(d) { return d.radius; })

		.style("fill", function(d) { return d.color; })
		.style("stroke", function(d) { return d.stroke; });
	//	 .call(force.drag); 
/*					
		var actlabel = svg.append("g").selectAll('.actlabel')
//		var actlabel = svg.selectAll('.actlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "actlabel")
*/
		var actlabel = layer2.selectAll('.actlabel')
//		var actlabel = svg.selectAll('.actlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "actlabel")	


		  
		  actlabel.append("text")
		  .attr("class", "actlabel")
          .attr("text-anchor", "middle")
		  .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y+20)
		  	.attr("dy", "-1.8em")
			.style("fill", "Black")
			.style("font-weight", "bold")
          .text(d => groups[d].fullname);
/*	
	// Count labels
	var cntlabel = svg.append("g").selectAll('.cntlabel')
//	var cntlabel = svg.selectAll('.cntlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "cntlabel")


		  
		  cntlabel.append("text")
		  .attr("class", "cnt")
          .attr("text-anchor", "middle")
		  .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y+20)
//          .attr("y", d => groups[d].y-10)
			.style("fill", "Black")
			.style("font-weight", "bold")
          .text(d => groups[d].cnt);	
//	console.log(sched_objs)	



*/
	
	// Count labels
	var cntlabel = layer2.selectAll('.cntlabel')
//	var cntlabel = svg.selectAll('.cntlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "cntlabel")


		  
		  cntlabel.append("text")
		  .attr("class", "cnt")
          .attr("text-anchor", "middle")
		  .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y+20)
//          .attr("y", d => groups[d].y-10)
			.style("fill", "Black")
			.style("font-weight", "bold")
          .text(d => groups[d].cnt);	
		  
//		  console.log(data[0])
		  
//		  sts_time = String(data[0].session_start_time.split(" ")[0])
//		  console.log(sts_time.split(" ")[0])
//		  console.log(data[0].session_start_time.split(" ")[0])
		  // Initial Date Time
//		  	d3.select("#current_date").text(data[0].start_time.split(" ")[0]);

		

//		curr_date = data[0].tstamp.split(" ")[0];

		curr_date = "02/07/2020"

		console.log(data[0])
		console.log(data[0]./*tstamp*/session_start_time)
		d3.select("#current_date").text(curr_date);
		console.log("test")

		


		d3.select("#elite").text(member_tiers.Elite.cnt)
		d3.select("#member").text(member_tiers.Member.cnt)
		d3.select("#eshopper").text(member_tiers.eshopper.cnt)
		d3.select("#anonymous").text(member_tiers.anonymous.cnt)		
		d3.select("#current_total_users").text("Total: " + (member_tiers.Elite.cnt+member_tiers.Member.cnt+member_tiers.eshopper.cnt+member_tiers.anonymous.cnt));

		org_prod_cat = "All";
	
		// Update nodes based on activity and duration
	function timer() {
			d3.select("#test").text("test "+document.getElementById("list_input").value)
		prod_cat_selected = document.getElementById("list_input").value;
//		 console.log(nodes);

	//	var i = curr_nodes.length;
	//	while(i--){
		d3.range(curr_nodes.length).map(function(i) {
            // var curr_node = nodes[i],
                // curr_moves = nodes[i].moves;
				
//			console.log("----------------");	
//			console.log(nodes);
		if (org_prod_cat != prod_cat_selected)
		{
	//	console.log(org_prod_cat)
	//	console.log(prod_cat_selected)
			filter_reset(curr_nodes[i]);
			if (prod_cat_selected == "p_personal_care")
			{
				if (curr_nodes[i].p_personal_care == "N")
					{
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

					}
			}
			
			else if (prod_cat_selected == "p_skincare")
			{
		console.log(curr_nodes[i].p_skincare)
				if (curr_nodes[i].p_skincare == "N")
					{
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

					}
			}
			

		}

//		d3.select("#test").text("test "+document.getElementById("list_input").value)
//		prod_cat_selected = document.getElementById("list_input").value;
		
		
		nodes.forEach(d => {
		

		

		
//		console.log(d)
//		console.log(d.sched[0].start_time)
			start_h = get_currDateTime(d.sched[0].start_time)[3].toString();
			start_m = get_currDateTime(d.sched[0].start_time)[4].toString();
			curr_h = minutesToTime(curr_minute)[1].toString();
			curr_m = minutesToTime(curr_minute)[2].toString();
//			console.log(get_currDateTime(d.sched[0].start_time));
	

		  if (start_h == curr_h && start_m == curr_m) {
//			console.log(start_h,curr_h)
//			console.log(d)
		  	if(!curr_nodes.some(e => e.userid == d.userid)) {
			
						if (prod_cat_selected == "p_personal_care")
			{
				if (d.p_personal_care == 0)
					{
						d.color = "transparent";
						d.stroke = "transparent";
					}
			}
			
			else if (prod_cat_selected == "p_skincare")
			{
				if (d.p_skincare == 0)
					{
						d.color = "transparent";
						d.stroke = "transparent";

					}
			}
	
				console.log(curr_nodes);
				console.log("new node");
				console.log(d);
//				console.log(curr_nodes);
				d.exist = 1;
				d.next_move_time += curr_minute;
				curr_nodes.push(d);
//				nodes.pop(d);
//				n2 = d;
//				n3 = n1.push(n2);
				if (d.color != "transparent")
				{
					groups[d.act].cnt += 1;
					member_tiers[d.member_tier].cnt += 1;
					d.stroke = "green";
				}
				
				console.log(curr_nodes);
				
//				force.nodes().push(d);

			
//			svg.selectAll("circle").remove();
/*			svg.selectAll("circle").remove();
				
//			circle = svg.selectAll(".node")
			circle = svg.selectAll(".node")
					.data(curr_nodes)
					.enter().append("circle")
					.attr("r", function(d) { return d.radius; })
					.style("fill", function(d) { return d.color; })
					.style("stroke", function(d) { return d.stroke; });
					

									

				force.start();*/

				}
				
			} 
			
			
			
		});
		


			// Time to go to next activity

			if (curr_nodes[i].next_move_time == curr_minute) {
		
				//console.log(curr_nodes[i].sched)
				if (curr_nodes.leave != 1)
				{
					curr_nodes.leave = 0;
				}
				curr_nodes[i].stroke = "transparent";
//				console.log(curr_nodes[i].moves, curr_nodes[i].sched.length-1)
/*				if (curr_nodes[i].moves == curr_nodes[i].sched.length-1) {
					curr_nodes[i].moves = 0;
				} else {
					curr_nodes[i].moves += 1;
				}*/
				
				curr_nodes[i].moves += 1;
				
//				console.log(curr_nodes[i].moves)
			
				// Subtract from current activity count
                // act_counts[curr_node.act] -= 1;
                //groups[curr_nodes[i].act].cnt -= 1;
				
			if (curr_nodes[i].leave == 1)
				{
					if (curr_nodes[i].color != "transparent")
					{
						groups[curr_nodes[i].act].cnt -= 1;
					}
	//				console.log("LEAVE")
					curr_nodes[i].act = "Left";
					if (curr_nodes[i].color != "transparent")
					{
						groups[curr_nodes[i].act].cnt += 1;
					}
					curr_nodes[i].next_move_time = curr_minute - 10;
					curr_nodes[i].exist = -1;
	//				console.log(curr_nodes[i].member_tier)
	//				console.log(member_tiers[curr_nodes[i].member_tier].cnt)
					if (curr_nodes[i].color != "transparent")
					{
					member_tiers[curr_nodes[i].member_tier].cnt -= 1;
					}
				//	curr_nodes = curr_nodes.splice(i,1);
				}
				
//				console.log(curr_nodes)

			else
			{
			
					// Move on to next activity
				try{
	//				console.log(curr_nodes[i].sched)
	//				console.log(curr_nodes[i].act)
	//				console.log(curr_nodes[i].moves)
	//				console.log(curr_nodes[i].next_move_time)
					
					if (curr_nodes[i].sched[ curr_nodes[i].moves ].act != "Other")
					{
						if (curr_nodes[i].color != "transparent")
						{
							groups[curr_nodes[i].act].cnt -= 1;
						}
						curr_nodes[i].act = curr_nodes[i].sched[ curr_nodes[i].moves ].act;
						if (curr_nodes[i].color != "transparent")
						{
							groups[curr_nodes[i].act].cnt += 1;
						}
						
	//					console.log(curr_nodes[i].act)
	//					curr_nodes[i].moves += 1;
					}
					// Add to new activity count
					// act_counts[curr_node.act] += 1;
					//groups[curr_nodes[i].act].cnt += 1;
					// nodes[i].moves = nodes[i].moves;
	//				curr_nodes[i].moves += 1;

					curr_nodes[i].next_move_time += parseInt(curr_nodes[i].sched[ curr_nodes[i].moves ].duration);
	//				console.log(" " + d_t[1] + ":" + d_t[2] + ":" + d_t[3] + d_t[4])
	//				console.log(curr_nodes[i].userid, curr_nodes[i].moves, curr_nodes[i].act)
	//				console.log(curr_minute, curr_nodes[i].next_move_time)
					}
					catch (err)
					{
						//curr_nodes[i].act = "Left";
						//groups[curr_nodes[i].act].cnt += 1;
						curr_nodes[i].next_move_time = curr_minute + 200;
						if (curr_nodes[i].color != "transparent")
						{
						curr_nodes[i].stroke = "red";
						}
						
						curr_nodes[i].leave = 1;
	//					console.log("error")
					}
				}


//				console.log(groups["Left"].cnt);
			}



					

									

				force.start();

		}
		
		
);

		force.resume();
		curr_minute += 1;

		// Update percentages
        cntlabel.selectAll("text.cnt")
            .text(d => groups[d].cnt);

	
		// Update time
  //      var true_minute = curr_minute % 1440;

		d_t = minutesToTime(curr_minute);
	
		d3.select("#current_date").text(d_t[0]);

        d3.select("#current_time").text(" " + d_t[1] + ":" + d_t[2] + ":" + d_t[3] + d_t[4]);
		
      	
	
					circle.remove();
				
//			circle = svg.selectAll(".node")
/*
			circle = svg
					.selectAll(".node")
					.data(curr_nodes)
					.enter().append("circle")
					 .attr("id", "nodes")
					.attr("r", function(d) { return d.radius; })
					.style("fill", function(d) { return d.color; })
					.style("stroke", function(d) { return d.stroke; });
*/

			circle = layer1
					.selectAll(".node")
					.data(curr_nodes)
					.enter().append("circle")
					 .attr("id", "nodes")
					.attr("r", function(d) { return d.radius; })
					.style("fill", function(d) { return d.color; })
					.style("stroke", function(d) { return d.stroke; });
					
					d3.select("#elite").text(member_tiers.Elite.cnt)
		d3.select("#member").text(member_tiers.Member.cnt)
		d3.select("#eshopper").text(member_tiers.eshopper.cnt)
		d3.select("#anonymous").text( member_tiers.anonymous.cnt)	
		d3.select("#current_total_users").text("Total: " + (member_tiers.Elite.cnt+member_tiers.Member.cnt+member_tiers.eshopper.cnt+member_tiers.anonymous.cnt));
		
		if (USER_SPEED != "pause") {
		    simtimer = setTimeout(timer, speeds[USER_SPEED]);
		}
		org_prod_cat = prod_cat_selected;
	//	console.log(org_prod_cat, prod_cat_selected)
	}
    // setTimeout(timer, speeds[USER_SPEED]);
	timer();		
//	console.log(curr_nodes);
	function tick(e) {
	
//	console.log(curr_nodes);
	  var k = 0.03 * e.alpha;
  
	  // Push nodes toward their designated focus.
	  curr_nodes.forEach(function(o, i) {
		var curr_act = o.act;
        
        o.y += (groups[curr_act].y - o.y) * k;
        o.x += (groups[curr_act].x-width*.01 - o.x) * k ;

        
	  });

	  circle
	  	  .each(collide(.5))
            // .style("fill", function(d) { return d.color; })
	      .attr("cx", function(d) { return d.x; })
	      .attr("cy", function(d) { return d.y; })
		  .style("stroke", function(d) { return d.stroke; });
		  

	}
	
		// Resolve collisions between nodes.
	function collide(alpha) {
	  var quadtree = d3.geom.quadtree(curr_nodes);
	  return function(d) {
	    var r = d.radius + maxRadius + padding,
	        nx1 = d.x - r,
	        nx2 = d.x + r,
	        ny1 = d.y - r,
	        ny2 = d.y + r;
	    quadtree.visit(function(quad, x1, y1, x2, y2) {
	      if (quad.point && (quad.point !== d)) {
	        var x = d.x - quad.point.x,
	            y = d.y - quad.point.y,
	            l = Math.sqrt(x * x + y * y),
	            r = d.radius + quad.point.radius + (d.act !== quad.point.act) * padding;
	        if (l < r) {
	          l = (l - r) / l * alpha;
	          d.x -= x *= l;
	          d.y -= y *= l;
	          quad.point.x += x;
	          quad.point.y += y;
	        }
	      }
	      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
	    });
	  };
	}
	
		// Speed toggle
	d3.selectAll(".togglebutton")
      .on("click", function() {
        if (d3.select(this).attr("data-val") == "pause") {
            d3.select(".pause").classed("current", true);
			d3.select(".medium").classed("current", false);
            d3.select(".fast").classed("current", false);
        } else if (d3.select(this).attr("data-val") == "medium") {
            d3.select(".pause").classed("current", false);
			d3.select(".medium").classed("current", true);
            d3.select(".fast").classed("current", false);
        } else {
            d3.select(".pause").classed("current", false);
			d3.select(".medium").classed("current", false);
			d3.select(".fast").classed("current", true);
        }
		
        force.resume();
        clearTimeout(simtimer);
		USER_SPEED = d3.select(this).attr("data-val");
        
        if (USER_SPEED != "pause") timer();
    });
}); // @end d3.tsv

function filter_reset (node)	{
	
	if (node.exist == 1)
	{
	if (node.color == "transparent")
	{
			groups[node.act].cnt += 1;
			member_tiers[node.member_tier].cnt += 1;
	}

	}

	if (node.leave == 1)
	{
		node.stroke = "red";
	}
	else if (node.leave == -1)
	{
		node.stroke = "green";
	}
	node.color = member_tiers[node.member_tier].color;
}

function filter_bubbles (node) {

	if (node.color != "transparent")
	{
	console.log(node.color)
	console.log(node)
		if (node.exist == 1)
		{
		console.log(node)
		console.log(node.color)
				groups[node.act].cnt -= 1;
				member_tiers[node.member_tier].cnt -= 1;
		}

		node.stroke = "transparent";
		node.color = "transparent";
	}

//		node.color = "transparent";
//		console.log(node.color)
	
	

	return node;
}

function get_currDateTime (d) {	
	
	curr_time_str = d.split(" ")[1] + ":00" ;
	
	if (curr_time_str.length != 8)
	{
		curr_time_str = "0" + curr_time_str;
	}
	
	
	curr_time_arr = curr_time_str.split(":");
	
	h_temp = parseInt(curr_time_arr[0]);
	
	if (h_temp > 12)
	{
		hh = h_temp-12;
	}
	else hh = h_temp
	

//	console.log(curr_time_arr)
//	hh = curr_time_arr[0];
	mm = curr_time_arr[1];
	ss = curr_time_arr[2];
	curr_date_str = d.split(" ")[0];
	curr_date_arr = curr_date_str.split("/");
	dd = parseInt(curr_date_arr[1]);
	MM = parseInt(curr_date_arr[0]);
	yyyy = parseInt(curr_date_arr[2]);
//	console.log(curr_time_str)
	
	if (hh == "00")
	{
		hh = "12";
	}
//	console.log(hh,mm,ss)
	
	return [dd, MM, yyyy, hh, mm, ss];

}
	
// Minutes to time of day. Data is minutes from 4am.
function minutesToTime(s) {
//	console.log(s)
	d = curr_date;

//	var seconds = s % 1440;
	var seconds = s;
//	var minutes = Math.floor(seconds / 60)

//	var hh = Math.floor(seconds/60 / 60);
	var ampm;
	
	var hh = Math.floor(s/3600);
//	console.log(hh)
	var mm = Math.floor(s/60) - (hh * 60);
//	console.log(mm)
	
	if (hh > 12) {
		hh = hh - 12;
		ampm = "pm";
	} else if (hh == 12) {
		ampm = "pm";
	} else if (hh == 0) {
		hh = 12;
		ampm = "am";
	} else {
		ampm = "am";
	}
	
	var ss = seconds % 60;
	if (ss<10) {
		ss = "0" + ss;
	}
	
	if (hh<10) {
		hh = "0" + hh;
	}
	
//	var mm = minutes % 60;
	
	
	if (mm < 10) {
		mm = "0" + mm;
	}
	

	t = " " + hh + ":" + mm + ":" + ss + ampm;

	return [d.toString(), hh.toString(), mm.toString(), ss.toString(), ampm.toString()];
}

// For SVG text-wrapping
function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        x = text.attr("x"),
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}


</script>    
