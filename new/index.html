<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>01022020</title>
<link rel="stylesheet" href="style/style.css" type="text/css" media="screen" />
<link rel="stylesheet" href="style/dropdown.css" type="text/css" media="screen" />

</head>

<div id="main-wrapper">


	<div id="sidebar">
<!--<div id="test">testint</div>-->

<div id="current_date">05/23/2020</div>
<div id="current_time">time</div><br><br>
<div id = "current_users_head" align="left" style="color:white">Current Online Users:</div>
<div id="current_users" >
	 <svg id = "legend_circle" xmlns="http://www.w3.org/2000/svg" version="1.1"
       width="20px" height="20px">
	   <circle cx="10" cy="10" r="10" style="fill: #C023EE;"/>
	   </svg>
	   <span id = "current_users_left" >Elite:</span> <span id = "elite" class = "right" >0</span><br>
	<svg id = "legend_circle" xmlns="http://www.w3.org/2000/svg" version="1.1"
       width="20px" height="20px" cx="-100">
	   <circle cx="10" cy="10" r="10" style="fill: #30C60C;"/>
	   </svg>
	<span id = "current_users_left">Member:</span> <span id = "member" class = "right">0</span><br>
	<svg id = "legend_circle" xmlns="http://www.w3.org/2000/svg" version="1.1"
       width="20px" height="20px" cx="-100">
	   <circle cx="10" cy="10" r="10" style="fill: #FEAB3D;"/>
	   </svg>
	<span id = "current_users_left">Eshopper:</span> <span id="eshopper" class = "right">0</span><br>
	<svg id = "legend_circle" xmlns="http://www.w3.org/2000/svg" version="1.1"
       width="20px" height="20px" cx="-100">
	   <circle cx="10" cy="10" r="10" style="fill: #54B7FF;"/>
	   </svg>
	<span id = "current_users_left">Anonymous:</span> <span id="anonymous" class = "right">0</span><br>
</div>
<div id="current_total_users" align="left">Total: 0</div>
<div class="container">
    <span class="choose" align="left">Select Member Type: </span>

    <div class="dropdown">
        <div class="select">
          <span id = "selected">Select Member Type </span><span id="right_arrow">â–¼</span>

        </div>
        <input type="hidden" name="gender" id="list_input">
        <ul class="dropdown-menu" id="list">
		 <li id="all">All</li>
         <li id="p_personal_care">p_Personal Care</li>
          <li id="p_skincare">p_Skincare</li>	
		  <li id="p_cosmetics">p_Cosmetics</li>
		<li id="p_health_care">p_Health Care</li>
		  <li id="p_body_hair_care">p_Body Hair Care</li>
		  <li id="p_sport">p_Sport</li>
		  <li id="p_men">p_Men</li>
		  <li id="p_other">p_Other</li>
		  <li id="p_derma">p_Derma</li>
		  <li id="p_watsons_brand">p_Watsons Brand</li>
		  <li id="p_bulk_buy">p_Bulk Buy</li>
		  <li id="b_personal_care">b_Personal Care</li>
          <li id="b_skincare">b_Skincare</li>	
		  <li id="b_cosmetics">b_Cosmetics</li>
			<li id="b_health_care">b_Health Care</li>
		  <li id="b_body_hair_care">b_Body Hair Care</li>
		  <li id="b_sport">b_Sport</li>
		  <li id="b_men">b_Men</li>
		  <li id="b_other">b_Other</li>
		  <li id="b_derma">b_Derma</li>
		  <li id="b_watsons_brand">b_Watsons Brand</li>
		  <li id="b_bulk_buy">b_Bulk Buy</li>		
        </ul>

      </div>

  <span class="msg"></span>
</div>
<div id="speed_text" align="left">Speed:</div><br>
<div id="speed">
<div class="togglebutton pause" data-val="pause">Pause</div>
<div class="togglebutton medium current" data-val="medium">Slow</div>
<div class="togglebutton fast" data-val="fast">Fast</div>



<div class="clr"></div>
</div>
<div id="note" style="text-align:center;"></div>
</div>



<!--
<svg id="chart_top" width="100%" height="100%"
  viewBox="0 0 1550 200"
  preserveAspectRatio="xMidYMid meet">
</svg>
-->
<!--    <div id="chart"></div> -->
	<svg id="chart" width="100%" height="100%"
	<!--  viewBox="0 0 1550 950" -->
	  preserveAspectRatio="xMidYMid meet">
	</svg>



</div><!-- @end #main-wrapper -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="js/d3-3-5-5.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100&Poiret+One&family=Press+Start+2P&family=Special+Elite&family=VT323&family=Creepster&display=swap" rel="stylesheet">

<script>


/*Dropdown Menu*/
$('.dropdown').click(function () {
        $(this).attr('tabindex', 1).focus();
        $(this).toggleClass('active');
        $(this).find('.dropdown-menu').slideToggle(300);
//		$(this).find('.dropdown-menu').css({'overflow-y': 'scroll'});
//		$(this).find('.dropdown-menu').css({'margin-left': '-1px'});
	//	$(this).find('.select').css({'border-radius': '4px 4px 0 0'});
    });
    $('.dropdown').focusout(function () {
        $(this).removeClass('active');
        $(this).find('.dropdown-menu').slideUp(300);
	//	$(this).find('.select').css({'border-radius': '4px 4px 4px 4px'});
    });
    $('.dropdown .dropdown-menu li').click(function () {
        $(this).parents('.dropdown').find('#selected').text($(this).text());
        $(this).parents('.dropdown').find('input').attr('value', $(this).attr('id'));
    });

/*End Dropdown Menu*/

/*var temp;
$('.dropdown-menu li').click(function () {
  var input = '<strong>' + $(this).parents('.dropdown').find('input').val() + '</strong>',
  temp = $(this).parents('.dropdown').find('input').val();
      msg = '<span class="msg">Channel Selected: ';
  $('.msg').html(msg + input + '</span>');
  console.log(document.getElementById("list_input").value)

});
*/


const people = {};
var USER_SPEED = "medium";

//var speeds = { "slow": 1200, "medium": 400, "fast": 100 };
var speeds = { "slow": 1200, "medium": 400, "fast": 50 };
var simtimer;

var curr_date;

var  date_update = 0;

var margin = {top: 70, right: 60, bottom: 70, left: 10};
margin.left = margin.right = width < 500 ? 30 : 70;
var width = parseInt(d3.select("#chart").style('width'), 10) - margin.left - margin.right,
    height = 1000 - margin.top - margin.bottom,
	padding = 2,
    maxRadius = width < 500 ? 2 : 4;

	// color = d3.scale.category10();

var x = d3.scale.linear()
    .domain([1, 3])
    .range([0, width]);

var y = d3.scale.linear()
    .domain([1, 4])
    .range([0, height]);

var	sched_objs = {},
// var sched_objs = [],
//	curr_minute = 0;
//	curr_minute = 79200 - 60; // 10pm - 1min
//	curr_minute = 82800 - 60; // 11pm - 1min
curr_minute = 28800 - 60;



	
//	chart_top.

//const svg = d3.select("#chart").append("svg")
//    .attr("width", width + margin.left + margin.right)

const svg = d3.select("#chart").append("svg")
	.attr("y", -20)
	.attr("width", "100%")
 //   .attr("height", height + margin.top + margin.bottom + 200)
 .attr("height", "100%")
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//d3.select("#chart").style("width", (width+margin.left+margin.right)+"px");



const background_left = svg.append("rect")
						.attr("x", -500)
						.attr("y", -50)
						.attr("width", 900)
			//			.attr("height", height + margin.top + margin.bottom +200)
						 .attr("height", "100%")
						.style("fill", "rgba(64, 71, 115, 1)")
//						.style("fill", "#ebebeb")
//						.style("fill", "#E9FFB7")



const background_right = svg.append("rect")
						.attr("x", 400)
						.attr("y", -50)
						.attr("width", "100%")
						//.attr("height", height + margin.top + margin.bottom +200)
						 .attr("height", "100%")
						.style("fill", "rgba(64, 71, 115, 1)")
//						.style("fill", "#FFFFFF")
//						.style("fill", "#6CADD3")


						
// Using for loop to draw multiple horizontal lines
 for (var j=-40; j <= 1000-25; j=j+25) {
     svg.append("svg:line")
         .attr("x1", -80)
         .attr("y1", j)
         .attr("x2", 1600-25)
         .attr("y2", j)
         .style("stroke", "rgba(6,120,155, 0.2)")
         .style("stroke-width", 2);            
 };
 
 // Using for loop to draw multiple vertical lines
 for (var j=-80; j <= 1600-25; j=j+25) {
     svg.append("svg:line")
         .attr("x1", j)
         .attr("y1", -60)
         .attr("x2", j)
         .attr("y2", height-25)
         .style("stroke", "rgba(6,120,155, 0.2)")
         .style("stroke-width", 2);            
 };

const middle_line = svg.append("rect")
						.attr("x", 400)
						.attr("y", -50)
						.attr("width", 5)
						//.attr("height", height + margin.top + margin.bottom +200)
						 .attr("height", "100%")
						.style("fill", "rgba(40, 44, 74, 1)")

		svg.append("text")
				.attr("x", -50)
				.attr("y", 0)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'Raleway', sans-serif")
				.text("Channels");
				
		svg.append("text")
				.attr("x", 430)
				.attr("y", 0)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'Raleway', sans-serif")
				.text("Page Types");

/*
const chart_top_left = svg.append("rect")
						.attr("x", -500)
						.attr("y", -50)
						.attr("width", 1000)
						.attr("height", 200)
						.style("fill", "rgba(256, 256, 256, 0.2)");
						
		svg.append("text")
				.attr("x", -50)
				.attr("y", 20)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Paid Search:");
		
		svg.append("text")
				.attr("x", 100)
				.attr("y", 20)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "paid_search_count")
				.style("font-family", "'VT323', monospace")
				.text("100");

		svg.append("text")
				.attr("x", -50)
				.attr("y", 50)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Social:");
		
		svg.append("text")
				.attr("x", 100)
				.attr("y", 50)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "social_count")
				.style("font-family", "'VT323', monospace")
				.text("100");

		svg.append("text")
				.attr("x", -50)
				.attr("y", 80)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Direct:");
		
		svg.append("text")
				.attr("x", 100)
				.attr("y", 80)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "direct_count")
				.style("font-family", "'VT323', monospace")
				.text("100");

		svg.append("text")
				.attr("x", -50)
				.attr("y", 110)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Web Push:");
		
		svg.append("text")
				.attr("x", 100)
				.attr("y", 110)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "web_push_count")
				.style("font-family", "'VT323', monospace")
				.text("100");

		svg.append("text")
				.attr("x", -50)
				.attr("y", 140)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Others:");
		
		svg.append("text")
				.attr("x", 100)
				.attr("y", 140)
				.attr("width", 570)
				.attr("height", 200)				
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "others_count")
				.style("font-family", "'VT323', monospace")
				.text("100");	
				
		svg.append("text")
				.attr("x", 220)
				.attr("y", 20)
				.attr("width", 570)
				.attr("height", 200)
			
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Organic Search:");
		
		svg.append("text")
				.attr("x", 400)
				.attr("y", 20)
				.attr("width", 570)
				.attr("height", 200)
			
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "organic_search_count")
				.style("font-family", "'VT323', monospace")
				.text("100");
				
		svg.append("text")
				.attr("x", 220)
				.attr("y", 50)
				.attr("width", 570)
				.attr("height", 200)		
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Referral:");
		
		svg.append("text")
				.attr("x", 400)
				.attr("y", 50)
				.attr("width", 570)
				.attr("height", 200)			
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "referral_count")
				.style("font-family", "'VT323', monospace")
				.text("100");				
				
		svg.append("text")
				.attr("x", 220)
				.attr("y", 80)
				.attr("width", 570)
				.attr("height", 200)		
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("Affiliate:");
		
		svg.append("text")
				.attr("x", 400)
				.attr("y", 80)
				.attr("width", 570)
				.attr("height", 200)			
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "affiliate_count")
				.style("font-family", "'VT323', monospace")
				.text("100");	

		svg.append("text")
				.attr("x", 220)
				.attr("y", 110)
				.attr("width", 570)
				.attr("height", 200)		
				.attr("fill", "white")
				.attr("font-size", "25px")
				.style("font-family", "'VT323', monospace")
				.text("O2O:");
		
		svg.append("text")
				.attr("x", 400)
				.attr("y", 110)
				.attr("width", 570)
				.attr("height", 200)			
				.attr("fill", "white")
				.attr("font-size", "25px")
				.attr("id", "o2o_count")
				.style("font-family", "'VT323', monospace")
				.text("100");

			

						
const chart_top_right = svg.append("rect")
						.attr("x", 500)
						.attr("y", -50)
						.attr("width", "100%")
						.attr("height", 200)
						.style("fill", "rgba(256, 256, 256, 0.2)");
*/
// Circle background
/*
svg.append("circle").attr("cx",1050).attr("cy",360).attr("r",320)
  .style("fill", "#69b3a2");
*/



// Legends
/*
const legned_svg = d3.select("#current_users").append("svg")
	.attr("width", "100%")
    .attr("height", "100%")
	.attr("viewBox","0 0 980 100")
	.attr( "preserveAspectRatio", "xMidYMid meet")
    .append("g")
 //   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

 legned_svg.append("circle")
// svg.append("circle")
	.attr("cx", 200)
	.attr("cy", -30)
	.attr("r", 100)
	.attr("fill", "#FF839A");

		legned_svg.append("text")
//	svg.append("text")
		.attr("x", 215)
		.attr("y", -25)
		.text(": Elite")
		.style("font-family", "'VT323', monospace")
			.style("fill", "White")
		.attr("font-size", "18px");
//		.attr("font-family", "sans-serif")
//		.attr("font-size", "12px");
	legned_svg.append("circle")
// svg.append("circle")
	.attr("cx", 320)
	.attr("cy", -30)
	.attr("r", 8)
	.attr("fill", "#83FFEE");

	legned_svg.append("text")
//	svg.append("text")
		.attr("x", 335)
		.attr("y", -25)
		.text(": Member")
		.style("font-family", "'VT323', monospace")
			.style("fill", "White")
		.attr("font-size", "18px");
//		.attr("font-family", "sans-serif")
//		.attr("font-size", "12px");

	legned_svg.append("circle")
//svg.append("circle")
	.attr("cx", 440)
	.attr("cy", -30)
	.attr("r", 8)
	.attr("fill", "#FDFF83");

	legned_svg.append("text")
//	svg.append("text")
		.attr("x", 455)
		.attr("y", -25)
		.text(": Eshopper")
		.style("font-family", "'VT323', monospace")
			.style("fill", "White")
		.attr("font-size", "18px");
//		.attr("font-family", "sans-serif")
//		.attr("font-size", "12px");

legned_svg.append("circle")
//svg.append("circle")
	.attr("cx", 560)
	.attr("cy", -30)
	.attr("r", 8)
	.attr("fill", "#E7E7E7");

	legned_svg.append("text")
//	svg.append("text")
		.attr("x", 575)
		.attr("y", -25)
		.text(": Anonymous")
		.style("font-family", "'VT323', monospace")
			.style("fill", "White")
		.attr("font-size", "18px");

*/
//Append circle



const groups = {

	"Paid Search": { x: 70, y: 70, cnt: 0, fullname: "Paid Search"},
	"Organic Search": { x: 240, y: 150, cnt: 0 , fullname: "Organic Search"},
	"Social": { x: 70, y: 230, cnt: 0, fullname: "Social"},
	"Referral": { x: 240, y: 290, cnt: 0, fullname: "Referral"},
	"Direct": { x: 70, y: 350, cnt: 0 , fullname: "Direct"},
	"Affiliate": { x: 240, y: 430, cnt: 0, fullname: "Affiliate"},
	"Web Push": { x: 70, y: 490, cnt: 0, fullname: "Web Push"},
	"O2O": { x: 240, y: 550, cnt: 0, fullname: "O2O"},
	"Others": { x: 70, y: 610, cnt: 0, fullname: "Others"},

	"Homepage": { x: 710, y: 150, cnt: 0, fullname: "Homepage" },
	"Login": { x: 840, y: 60, cnt: 0, fullname: "Login" },	
	"Product": { x: 700, y: 560, cnt: 0, fullname: "Product" },
	"Other": { x: 1220, y: 530, cnt: 0, fullname: "Promo&Others" },
	"Category": { x: 640, y: 260, cnt: 0, fullname: "Category" },
	"BlogContent": { x: 1270, y: 280, cnt: 0, fullname: "Blog Content" },
	"Cart": { x: 800, y: 640, cnt: 0, fullname: "Cart" },
	"Checkout": {  x: 950, y: 680, cnt: 0, fullname: "Checkout" },
	"Loyalty": { x: 1250, y: 230, cnt: 0, fullname: "Loyalty" },
	"MyAccount": { x: 1170, y: 110, cnt: 0, fullname: "My Account" },
	"Register": { x: 1000, y: 40, cnt: 0, fullname: "Register" },
	"SearchResult": { x: 630, y: 400, cnt: 0, fullname: "Search Result" },
	"Left" : { x: 750, y: 20000, cnt: 0, fullname: "Left" },
	"NULL" : { x: 1100, y: 630, cnt: 0, fullname: "Order Placed" }

};

const member_tiers = {

	"Elite": { color: "#C023EE", cnt: 0 },
//	"anonymous": { color: "#528EFF", cnt: 0 },
	"anonymous": { color: "#54B7FF", cnt: 0 },
	"Member": {color: "#30C60C", cnt: 0},
	"eshopper": {color: "#FEAB3D", cnt: 0}

};



var layer1 = svg.append('g');
var layer2 = svg.append('g');


// Load data.

d3.csv("data/0523_8am_exceptallN.csv", function(error, data) {
//d3.csv("data/Page_Duration.csv", function(error, data) {
//d3.csv("data/data0201.csv", function(error, data) {
//d3.csv("data/data_channels.csv", function(error, data) {
//d3.csv("data/Book1.csv", function(error, data) {
//d3.csv("data/new_test.csv", function(error, data) {
//d3.csv("data/test2.csv", function(error, data) {
//d3.csv("data/new_dataset.csv", function(error, data) {

/*	data.forEach(function(d) {

		var activities = [];
		console.log(d)
		console.log(d.pagetype)
		activities.push({'act': d.pagetype, 'duration': d.page_duration, 'tier': d.member_tier});
		sched_objs.push(activities);
	}); */
	console.log(data)
	var count = 0;



	data.forEach(d => {
//	console.log(d)
//	count+=1;
		if (d3.keys(sched_objs).includes(d.sessionid+"")) {
//        if (d3.keys(sched_objs).includes(d.userid+"")) {
//		console.log(d.userid)
//            sched_objs[d.userid+""].push({'userid': d.userid, 'act': d.pagetype, 'duration': d.page_duration, 'member_tier': d.member_tier, 'start_time': d.start_time});
			sched_objs[d.sessionid+""].push({'userid': d.sessionid,
											'act': d.pagetype,
											'duration': d.page_duration,
											'member_tier': d.member_tier,
											'start_time': /*d.tstamp*/d.session_start_time,
											'medium':d.medium,
											'p_personal_care': d.p_personal_care,
											'p_skincare': d.p_skincare,
											'p_cosmetics': d.p_cosmetics,
											'p_health_care': d.p_health_care,
											'p_body_hair_care': d.p_body_hair_care,
											'p_sport': d.p_sport,
											'p_men': d.p_men,
											'p_other': d.p_other,
											'p_derma': d.p_derma,
											'p_watsons_brand': d.p_watsons_brand,
											'p_bulk_buy': d.p_bulk_buy,
											'b_personal_care': d.b_personal_care,
											'b_skincare': d.b_skincare,
											'b_cosmetics': d.b_cosmetics,
											'b_health_care': d.b_health_care,
											'b_body_hair_care': d.b_body_hair_care,
											'b_sport': d.b_sport,
											'b_men': d.b_men,
											'b_other': d.b_other,
											'b_derma': d.b_derma,
											'b_watsons_brand': d.b_watsons_brand,
											'b_bulk_buy': d.b_bulk_buy,
											});
        } else {
//            sched_objs[d.userid+""] = [{'userid': d.userid, 'act': d.pagetype, 'duration': d.page_duration, 'member_tier': d.member_tier, 'start_time': d.start_time}];
			sched_objs[d.sessionid+""] = [{'userid': d.sessionid,
											'act': d.pagetype,
											'duration': Math.floor(d.page_duration),
											'member_tier': d.member_tier,
											'start_time': /*d.tstamp*/d.session_start_time,
											'medium':d.medium,
											'p_personal_care': d.p_personal_care,
											'p_skincare': d.p_skincare,
											'p_cosmetics': d.p_cosmetics,
											'p_health_care': d.p_health_care,
											'p_body_hair_care': d.p_body_hair_care,
											'p_sport': d.p_sport,
											'p_men': d.p_men,
											'p_other': d.p_other,
											'p_derma': d.p_derma,
											'p_watsons_brand': d.p_watsons_brand,
											'p_bulk_buy': d.p_bulk_buy,
											'b_personal_care': d.b_personal_care,
											'b_skincare': d.b_skincare,
											'b_cosmetics': d.b_cosmetics,
											'b_health_care': d.b_health_care,
											'b_body_hair_care': d.b_body_hair_care,
											'b_sport': d.b_sport,
											'b_men': d.b_men,
											'b_other': d.b_other,
											'b_derma': d.b_derma,
											'b_watsons_brand': d.b_watsons_brand,
											'b_bulk_buy': d.b_bulk_buy,
											}];
        }
    });



/*	var nodes = sched_objs.map(function(o,i) {
//		console.log("test");
		console.log(o[0].userid,o[0].start_time, o[0].duration);

		var act = o[0].act;
		var init_time = o[0].start_time;

		var init_x = groups[act].x + Math.random();
		var init_y = groups[act].y + Math.random();
		var col = member_tiers[o[0].member_tier].color;

	//	groups[act].cnt += 1;

		return {
			userid: o[0].userid,
			act: act,
			radius: maxRadius,
			x: init_x,
			y: init_y,
			color: col, //color(act),
			moves: 0,
			next_move_time: parseInt(o[0].duration),
			sched: o,
			stroke: "black",
			start_time: init_time
		}
	});*/

	var nodes = [];

	console.log(Object.keys(sched_objs).length)
	console.log(sched_objs);

	for (var k in sched_objs){
//		console.log(k)
		d = sched_objs[k];



//		console.log(d[0].userid,d[0].start_time, d[0].duration);
//		console.log(k)

		var act = d[0].act;
		var init_time = d[0].start_time;


		var col = member_tiers[d[0].member_tier].color;

		var temp_medium = d[0].medium;
		var medium = "Others";

		if (temp_medium == 'cpc')
		{
			medium = 'Paid Search';
		}
		else if (temp_medium == 'organic')
		{
			medium = 'Organic Search';
		}
		else if (temp_medium == 'social')
		{
			medium = 'Social';
		}
		else if (temp_medium == 'referral')
		{
			medium = 'Referral';
		}
		else if (temp_medium == 'NULL')
		{
			medium = 'Direct';
		}
		else if (temp_medium == 'affiliate')
		{
			medium = "Affiliate";
		}
		else if (temp_medium == 'web_push')
		{
			medium = "Web Push";
		}
		else if (temp_medium.match(/sms/g) != null)
		{
			medium = "O2O";
		}

		d.unshift({'userid': d[0].userid,
			'act': medium,
			'duration': 60,
			'member_tier': d[0].member_tier,
			'start_time': /*d.tstamp*/init_time,
			'medium':medium,
			'p_personal_care': d[0].p_personal_care,
			'p_skincare': d[0].p_skincare,
			'p_cosmetics': d[0].p_cosmetics,
			'p_health_care': d[0].p_health_care,
			'p_body_hair_care': d[0].p_body_hair_care,
			'p_sport': d[0].p_sport,
			'p_men': d[0].p_men,
			'p_other': d[0].p_other,
			'p_derma': d[0].p_derma,
			'p_watsons_brand': d[0].p_watsons_brand,
			'p_bulk_buy': d[0].p_bulk_buy,
			'b_personal_care': d[0].b_personal_care,
			'b_skincare': d[0].b_skincare,
			'b_cosmetics': d[0].b_cosmetics,
			'b_health_care': d[0].b_health_care,
			'b_body_hair_care': d[0].b_body_hair_care,
			'b_sport': d[0].b_sport,
			'b_men': d[0].b_men,
			'b_other': d[0].b_other,
			'b_derma': d[0].b_derma,
			'b_watsons_brand': d[0].b_watsons_brand,
			'b_bulk_buy': d[0].b_bulk_buy,	})

	//	groups[act].cnt += 1;
/*
		var init_x = groups[act].x + Math.random();
		var init_y = groups[act].y + Math.random();
*/
		var init_x = groups[medium].x + Math.random();
		var init_y = groups[medium].y + Math.random();

//		console.log(d[0])

		nodes.push({
			userid: d[0].userid,
			act: medium,
//			radius: maxRadius,
			radius: 10,
			x: init_x,
			y: init_y,
			color: col, //color(act),
			moves: 0,
			next_move_time: parseInt(d[0].duration) + curr_minute,
			sched: d,
			stroke: "blue",
			start_time: init_time,
			leave: 0,
			exist: 0,
			member_tier: d[0].member_tier,
			medium: medium,
			p_personal_care: d[0].p_personal_care,
			p_skincare: d[0].p_skincare,
			p_cosmetics: d[0].p_cosmetics,
			p_health_care: d[0].p_health_care,
			p_body_hair_care: d[0].p_body_hair_care,
			p_sport: d[0].p_sport,
			p_men: d[0].p_men,
			p_other: d[0].p_other,
			p_derma: d[0].p_derma,
			p_watsons_brand: d[0].p_watsons_brand,
			p_bulk_buy: d[0].p_bulk_buy,
			b_personal_care: d[0].b_personal_care,
			b_skincare: d[0].b_skincare,
			b_cosmetics: d[0].b_cosmetics,
			b_health_care: d[0].b_health_care,
			b_body_hair_care: d[0].b_body_hair_care,
			b_sport: d[0].b_sport,
			b_men: d[0].b_men,
			b_other: d[0].b_other,
			b_derma: d[0].b_derma,
			b_watsons_brand: d[0].b_watsons_brand,
			b_bulk_buy: d[0].b_bulk_buy,
		})

	}

	console.log(nodes)

	var curr_nodes = [];


//	console.log(data)
	nodes.forEach(d => {
//		console.log(d.sched[0].start_time)

      if (d.sched[0].start_time == data[0]./*tstamp*/session_start_time) {
			console.log(d.sched[0])
			d.exist = 1;
			d.leave = -1;
/*			if (d.act == "Other")
			{
			//console.log(d.sched[1])
				try{d.act = d.sched[1].act;}
				catch(err){}
			}
*/
//			console.log(d)

//				console.log(d);
			if (d.color != "transparent")
			{
//				groups[d.act].cnt += 1;
				groups[d.act].cnt += 1;
				member_tiers[d.member_tier].cnt += 1;
				d.stroke = "green";
			}
		var count = 0;
/*		
		if (d.medium == "Paid Search")
		{
			count = parseInt(d3.select('#paid_search_count').text()) + 1; 
			d3.select('#paid_search_count').text(count);
		}
		else if (d.medium == "Organic Search")
		{
			count = parseInt(d3.select('#organic_search_count').text()) + 1;
			d3.select('#organic_search_count').text(count);
		}
		else if (d.medium == "Social")
		{
			count = parseInt(d3.select('#social_count').text())
			d3.select('#social_count').text(count+=1);
		}
		else if (d.medium == "Referral")
		{
			count = parseInt(d3.select('#referral_count').text())
			d3.select('#referral_count').text(count+=1);
		}
		else if (d.medium == "Direct")
		{
			count = parseInt(d3.select('#direct_count').text())
			d3.select('#direct_count').text(count+=1);
		}
		else if (d.medium == "Affiliate")
		{
			count = parseInt(d3.select('#affiliate_count').text())
			d3.select('#affiliate_count').text(count+=1);
		}
		else if (d.medium == "Web Push")
		{
			count = parseInt(d3.select('#web_push_count').text())
			d3.select('#web_push_count').text(count+=1);
		}
		else if (d.medium == "O2O")
		{
			count = parseInt(d3.select('#o2o_count').text())
			d3.select('#o2o_count').text(count+=1);
		}
*/			
			curr_nodes.push(d);
//			console.log(d.medium)
//			nodes.pop(d);
        }

    });
	
	nodes = nodes.filter(x => !curr_nodes.includes(x));
	
	console.log(nodes);
	
	
//	console.log(member_tiers.eshopper.cnt);
//	curr_nodes = nodes.filter(function(d){ return d.sched[0].start_time == data[0].start_time } );
//	curr_nodes = nodes.filter(function(d){ return d.sched[0].start_time == data[0].tstamp } );
/*	curr_nodes.forEach(d => {
		groups[d.act].cnt += 1;
	}
	);*/


	//curr_nodes = nodes.filter(d => d.sched[0].start_time == data[0].start_time);
//	console.log(nodes.length)
//	curr_nodes = nodes

	console.log(curr_nodes)

	// Activity group labels
 /*   var actlabel = svg.selectAll("text")
        .data(d3.keys(groups))
      .enter().append("text")
        .attr("class", "actlabel")
        .attr("text-anchor", "middle")
          .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y)
		.attr("dy", "-1.8em")
        .text(d => groups[d].fullname);*/



	var force = d3.layout.force()
		.nodes(curr_nodes)
		// .links([])
		.size([width, height])
		.gravity(0)
		.charge(0.2)
		.friction(.8)
		.on("tick", tick)
		.start();
/*
	var circle = svg.append("g")
				.attr("id", "circle_node")
				.selectAll(".node")
//	var circle = svg.selectAll(".node")
				.data(curr_nodes)
			  .enter().append("circle")
				.attr("r", function(d) { return d.radius; })

		.style("fill", function(d) { return d.color; })
		.style("stroke", function(d) { return d.stroke; });
	//	 .call(force.drag);
*/

		var circle = layer1
				.attr("id", "circle_node")
				.selectAll(".node")
//	var circle = svg.selectAll(".node")
				.data(curr_nodes)
			  .enter().append("circle")
				.attr("r", function(d) { return d.radius; })

		.style("fill", function(d) { return d.color; })
		.style("stroke", function(d) { return d.stroke; })
		.style("stroke-width", 4.5)

//		 .call(force.drag);
/*
		var actlabel = svg.append("g").selectAll('.actlabel')
//		var actlabel = svg.selectAll('.actlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "actlabel")
*/
		var actlabel = layer2.selectAll('.actlabel')
//		var actlabel = svg.selectAll('.actlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "actlabel")



		  actlabel.append("text")
		  .attr("class", "actlabel")
          .attr("text-anchor", "middle")
		  .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y+20)
		  	.attr("dy", "-1.8em")
			.style("fill", "#FFFFFF")
//			.style("fill", "#B11F00")
			.style("font-weight", "bold")
//			.style("font-family", "'Creepster', cursive")
			.style("font-family", "'Raleway', sans-serif")

		.attr("font-size", "20px")
          .text(d => groups[d].fullname);
/*
	// Count labels
	var cntlabel = svg.append("g").selectAll('.cntlabel')
//	var cntlabel = svg.selectAll('.cntlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "cntlabel")



		  cntlabel.append("text")
		  .attr("class", "cnt")
          .attr("text-anchor", "middle")
		  .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y+20)
//          .attr("y", d => groups[d].y-10)
			.style("fill", "Black")
			.style("font-weight", "bold")
          .text(d => groups[d].cnt);
//	console.log(sched_objs)



*/

	// Count labels
	var cntlabel = layer2.selectAll('.cntlabel')
//	var cntlabel = svg.selectAll('.cntlabel')
      .data(d3.keys(groups))
	        .enter().append("g")
          .attr("class", "cntlabel")



		  cntlabel.append("text")
		  .attr("class", "cnt")
          .attr("text-anchor", "middle")
		  .attr("x", d => groups[d].x)
          .attr("y", d => groups[d].y+30)
//          .attr("y", d => groups[d].y-10)
			.style("fill", "#FFFFFF")
//			.style("fill", "#B11F00")
//			.style("font-weight", "bold")
//			.style("font-family", "'Creepster', cursive")
			.style("font-family", "'Raleway', sans-serif")
		.attr("font-size", "50px")
		.attr("font-weight", "bold")
          .text(d => groups[d].cnt);

//		  console.log(data[0])

//		  sts_time = String(data[0].session_start_time.split(" ")[0])
//		  console.log(sts_time.split(" ")[0])
//		  console.log(data[0].session_start_time.split(" ")[0])
		  // Initial Date Time
//		  	d3.select("#current_date").text(data[0].start_time.split(" ")[0]);



//		curr_date = data[0].tstamp.split(" ")[0];

		curr_date = "05/23/2020"

//		console.log(data[0])
//		console.log(data[0]./*tstamp*/session_start_time)
	//	d3.select("#current_date").text(curr_date);
//		console.log("test")




		d3.select("#elite").text(member_tiers.Elite.cnt)
		d3.select("#member").text(member_tiers.Member.cnt)
		d3.select("#eshopper").text(member_tiers.eshopper.cnt)
		d3.select("#anonymous").text(member_tiers.anonymous.cnt)
		d3.select("#current_total_users").text("Total: " + (member_tiers.Elite.cnt+member_tiers.Member.cnt+member_tiers.eshopper.cnt+member_tiers.anonymous.cnt));

		org_prod_cat = "All";

		// Update nodes based on activity and duration
	function timer() {
//			d3.select("#test").text("test "+document.getElementById("list_input").value)
		prod_cat_selected = document.getElementById("list_input").value;
//		 console.log(nodes);

	//	var i = curr_nodes.length;
	//	while(i--){
		d3.range(curr_nodes.length).map(function(i) {
            // var curr_node = nodes[i],
                // curr_moves = nodes[i].moves;

//			console.log("----------------");
//			console.log(nodes);
		if (org_prod_cat != prod_cat_selected)
		{
//		console.log(org_prod_cat)
//		console.log(prod_cat_selected)
			filter_reset(curr_nodes[i]);

			if (prod_cat_selected == "p_personal_care" && curr_nodes[i].p_personal_care == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_skincare" && curr_nodes[i].p_skincare == "N")
			{
			
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_cosmetics" && curr_nodes[i].p_cosmetics == "N")

			{
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}
			
			else if (prod_cat_selected == "p_health_care" && curr_nodes[i].p_health_care == "N")
			{
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);
			}

			else if (prod_cat_selected == "p_body_hair_care" && curr_nodes[i].p_body_hair_care == "N")
			{
	
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_sport" && curr_nodes[i].p_sport == "N")
			{

						curr_nodes[i] = filter_bubbles (curr_nodes[i]);
		
			}

			else if (prod_cat_selected == "p_men" && curr_nodes[i].p_men == "N")
			{
		
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_other" && curr_nodes[i].p_other == "N")
			{
		
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_derma" && curr_nodes[i].p_derma == "N")
			{
		
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_watsons_brand" && curr_nodes[i].p_watsons_brand == "N")
			{
			
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "p_bulk_buy" && curr_nodes[i].p_bulk_buy == "N")
			{			
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);
		
			}

			else if (prod_cat_selected == "b_personal_care" && curr_nodes[i].b_personal_care == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_skincare" && curr_nodes[i].b_skincare == "N")
			{
		
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_cosmetics" && curr_nodes[i].b_cosmetics == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}
			
			else if (prod_cat_selected == "b_health_care" && curr_nodes[i].b_health_care == "N")
			{
			
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_body_hair_care" && curr_nodes[i].b_body_hair_care == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_sport" && curr_nodes[i].b_sport == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_men" && curr_nodes[i].b_men == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_other" && curr_nodes[i].b_other == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_derma" && curr_nodes[i].b_derma == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_watsons_brand" && curr_nodes[i].b_watsons_brand == "N")
			{
				
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}

			else if (prod_cat_selected == "b_bulk_buy" && curr_nodes[i].b_bulk_buy == "N")
			{
		
						curr_nodes[i] = filter_bubbles (curr_nodes[i]);

			}
			else {}

		}

//		d3.select("#test").text("test "+document.getElementById("list_input").value)
//		prod_cat_selected = document.getElementById("list_input").value;


		nodes.forEach(d => {





//		console.log(d)
//		console.log(d.sched[0].start_time)
			start_h = get_currDateTime(d.sched[0].start_time)[3];
			start_m = get_currDateTime(d.sched[0].start_time)[4];
			curr_h = minutesToTime(curr_minute)[1];
			curr_m = minutesToTime(curr_minute)[2];
//			console.log(start_m)
			if (start_m == "00")
			{
				start_m = 59;
				start_h -= 1;
			}
			else {start_m -= 1}

//		console.log(start_h,start_m, minutesToTime(curr_minute))
		  if (start_h == curr_h && start_m == curr_m) {
//			console.log(start_h,curr_h)
//			console.log(d)
		  	if(!curr_nodes.some(e => e.userid == d.userid)) {
/*			
					var count = 0;
		if (d.medium == "Paid Search")
		{
			count = parseInt(d3.select('#paid_search_count').text()) + 1; 
			d3.select('#paid_search_count').text(count);
		}
		else if (d.medium == "Organic Search")
		{
			count = parseInt(d3.select('#organic_search_count').text()) + 1;
			d3.select('#organic_search_count').text(count);
		}
		else if (d.medium == "Social")
		{
			count = parseInt(d3.select('#social_count').text())
			d3.select('#social_count').text(count+=1);
		}
		else if (d.medium == "Referral")
		{
			count = parseInt(d3.select('#referral_count').text())
			d3.select('#referral_count').text(count+=1);
		}
		else if (d.medium == "Direct")
		{
			count = parseInt(d3.select('#direct_count').text())
			d3.select('#direct_count').text(count+=1);
		}
		else if (d.medium == "Affiliate")
		{
			count = parseInt(d3.select('#affiliate_count').text())
			d3.select('#affiliate_count').text(count+=1);
		}
		else if (d.medium == "Web Push")
		{
			count = parseInt(d3.select('#web_push_count').text())
			d3.select('#web_push_count').text(count+=1);
		}
		else if (d.medium == "O2O")
		{
			count = parseInt(d3.select('#o2o_count').text())
			d3.select('#o2o_count').text(count+=1);
		}
*/
		if (prod_cat_selected == "p_personal_care" && d.p_personal_care == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}

			else if (prod_cat_selected == "p_skincare" && d.p_skincare == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}
			
			else if (prod_cat_selected == "p_cosmetics" && d.p_cosmetics == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}
			
			else if (prod_cat_selected == "p_health_care" && d.p_health_care == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}
			
			else if (prod_cat_selected == "p_body_hair_care" && d.p_body_hair_care == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}
			
			else if (prod_cat_selected == "p_sport" && d.p_sport == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}	

			else if (prod_cat_selected == "p_men" && d.p_men == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}		

			else if (prod_cat_selected == "p_other" && d.p_other == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}

			else if (prod_cat_selected == "p_derma" && d.p_derma == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}	

			else if (prod_cat_selected == "p_watsons_brand" && d.p_watsons_brand == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}

			else if (prod_cat_selected == "p_bulk_buy" && d.p_bulk_buy == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}		

			else if (prod_cat_selected == "b_personal_care" && d.b_personal_care == "N")
			{
			
						d.color = "transparent";
						d.stroke = "transparent";

			}					
			
			else if (prod_cat_selected == "b_skincare" && d.b_skincare == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}	
			
			else if (prod_cat_selected == "b_cosmetics" && d.b_cosmetics == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}	

			else if (prod_cat_selected == "b_health_care" && d.b_health_care == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}	
			
			else if (prod_cat_selected == "b_body_hair_care" && d.b_body_hair_care == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}

			else if (prod_cat_selected == "b_sport" && d.b_sport == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}

			else if (prod_cat_selected == "b_men" && d.b_men == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}
			
			else if (prod_cat_selected == "b_other" && d.b_other == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}
			
			else if (prod_cat_selected == "b_derma" && d.b_derma == "N")
			{
			
						d.color = "transparent";
						d.stroke = "transparent";

			
			}
			
			else if (prod_cat_selected == "b_watsons_brand" && d.b_watsons_brand == "N")
			{
				
						d.color = "transparent";
						d.stroke = "transparent";

			}	

			else if (prod_cat_selected == "b_bulk_buy" && d.b_bulk_buy == "N")
			{
			
						d.color = "transparent";
						d.stroke = "transparent";

			}				


//				console.log(curr_nodes);
//				console.log("new node");
//				console.log(d);
//				console.log(curr_nodes);
				d.exist = 1;
				d.leave = -1;
				d.next_move_time = curr_minute + 60;
				curr_nodes.push(d);
//				nodes.pop(d);
//				n2 = d;
//				n3 = n1.push(n2);
				if (d.color != "transparent")
				{
					groups[d.act].cnt += 1;
					member_tiers[d.member_tier].cnt += 1;
					d.stroke = "green";
				}

//				console.log(curr_nodes);

//				force.nodes().push(d);


//			svg.selectAll("circle").remove();
/*			svg.selectAll("circle").remove();

//			circle = svg.selectAll(".node")
			circle = svg.selectAll(".node")
					.data(curr_nodes)
					.enter().append("circle")
					.attr("r", function(d) { return d.radius; })
					.style("fill", function(d) { return d.color; })
					.style("stroke", function(d) { return d.stroke; });




				force.start();*/

				}

			}



		});



			// Time to go to next activity
			if (curr_nodes[i].next_move_time == curr_minute) {

				//console.log(curr_nodes[i].sched)


					if (! ["Paid Search", "Organic Search", "Social", "Referral", "Direct", "Affiliate", "Web Push", "O2O", "Others"].includes(curr_nodes[i].act))
					{
						curr_nodes[i].stroke = "transparent";
										if (curr_nodes.leave != 1)
				{
					curr_nodes.leave = 0;
				}
					}

//				console.log(curr_nodes[i].moves, curr_nodes[i].sched.length-1)
/*				if (curr_nodes[i].moves == curr_nodes[i].sched.length-1) {
					curr_nodes[i].moves = 0;
				} else {
					curr_nodes[i].moves += 1;
				}*/

				curr_nodes[i].moves += 1;

//				console.log(curr_nodes[i].moves)

				// Subtract from current activity count
                // act_counts[curr_node.act] -= 1;
                //groups[curr_nodes[i].act].cnt -= 1;

			if (curr_nodes[i].leave == 1)
				{
					if (curr_nodes[i].color != "transparent")
					{
						groups[curr_nodes[i].act].cnt -= 1;
						member_tiers[curr_nodes[i].member_tier].cnt -= 1;
					}
	//				console.log("LEAVE")
					curr_nodes[i].act = "Left";
					if (curr_nodes[i].color != "transparent")
					{
	//					groups[curr_nodes[i].act].cnt += 1;
					}
					curr_nodes[i].next_move_time = curr_minute - 10;
					curr_nodes[i].exist = -1;
	//				console.log(curr_nodes[i].member_tier)
	//				console.log(member_tiers[curr_nodes[i].member_tier].cnt)
	/*
					if (curr_nodes[i].color != "transparent")
					{
						member_tiers[curr_nodes[i].member_tier].cnt -= 1;
					}
	*/
				//	curr_nodes = curr_nodes.splice(i,1);
				}

//				console.log(curr_nodes)

			else
			{

					// Move on to next activity
				try{
	//				console.log(curr_nodes[i].sched)
	//				console.log(curr_nodes[i].act)
	//				console.log(curr_nodes[i].moves)
	//				console.log(curr_nodes[i].next_move_time)
//					console.log(curr_nodes[i])
	//				if (curr_nodes[i].sched[ curr_nodes[i].moves ].act != "Other")
	//				{
						var act = curr_nodes[i].sched[ curr_nodes[i].moves ].act

						if (curr_nodes[i].color != "transparent")
						{
							groups[curr_nodes[i].act].cnt -= 1;
						}
						curr_nodes[i].act = act;
						if (curr_nodes[i].color != "transparent")
						{
//							console.log(curr_nodes[i])
							groups[curr_nodes[i].act].cnt += 1;
						}

	//					console.log(curr_nodes[i].act)
	//					curr_nodes[i].moves += 1;
	//				}
	//				}
					// Add to new activity count
					// act_counts[curr_node.act] += 1;
					//groups[curr_nodes[i].act].cnt += 1;
					// nodes[i].moves = nodes[i].moves;
	//				curr_nodes[i].moves += 1;

					curr_nodes[i].next_move_time += parseInt(curr_nodes[i].sched[ curr_nodes[i].moves ].duration);
	//				console.log(" " + d_t[1] + ":" + d_t[2] + ":" + d_t[3] + d_t[4])
	//				console.log(curr_nodes[i].userid, curr_nodes[i].moves, curr_nodes[i].act)
	//				console.log(curr_minute, curr_nodes[i].next_move_time)
					}
					catch (err)
					{
						//curr_nodes[i].act = "Left";
						//groups[curr_nodes[i].act].cnt += 1;
						curr_nodes[i].next_move_time = curr_minute + 60;
						if (curr_nodes[i].color != "transparent")
						{
							curr_nodes[i].stroke = "red";
						}

						curr_nodes[i].leave = 1;
	//					console.log("error")
					}
				}


//				console.log(groups["Left"].cnt);
			}




				force.start();

		}




);

	//		curr_nodes = curr_nodes.filter(function(node) { return node.next_move_time>curr_minute});
		

		nodes = nodes.filter(x => !curr_nodes.includes(x));


		for (var i =curr_nodes.length - 1; i >= 0; --i) {
		if ((curr_nodes[i].next_move_time < curr_minute) && (curr_nodes[i].act == "Left")) {
			console.log(curr_nodes)
			curr_nodes.splice(i,1);
			}
		}

//	console.log(groups["Left"].cnt);

		force.resume();
		curr_minute += 1;

		// Update percentages
        cntlabel.selectAll("text.cnt")
            .text(d => groups[d].cnt);


		// Update time
  //      var true_minute = curr_minute % 1440;

		d_t = minutesToTime(curr_minute);

//		d3.select("#current_date").text(d_t[0]);

        d3.select("#current_time").text(" " + d_t[1] + ":" + d_t[2] + ":" + d_t[3] + d_t[4]);



					circle.remove();

//			circle = svg.selectAll(".node")
/*
			circle = svg
					.selectAll(".node")
					.data(curr_nodes)
					.enter().append("circle")
					 .attr("id", "nodes")
					.attr("r", function(d) { return d.radius; })
					.style("fill", function(d) { return d.color; })
					.style("stroke", function(d) { return d.stroke; });
*/

			circle = layer1
					.selectAll(".node")
					.data(curr_nodes)
					.enter().append("circle")
					 .attr("id", "nodes")
					.attr("r", function(d) { return d.radius; })
					.style("fill", function(d) { return d.color; })
					.style("stroke", function(d) { return d.stroke; })
					.style("stroke-width", 4.5);

					d3.select("#elite").text(member_tiers.Elite.cnt)
		d3.select("#member").text(member_tiers.Member.cnt)
		d3.select("#eshopper").text(member_tiers.eshopper.cnt)
		d3.select("#anonymous").text( member_tiers.anonymous.cnt)
		d3.select("#current_total_users").text("Total: " + (member_tiers.Elite.cnt+member_tiers.Member.cnt+member_tiers.eshopper.cnt+member_tiers.anonymous.cnt));

		if (USER_SPEED != "pause") {
		    simtimer = setTimeout(timer, speeds[USER_SPEED]);
		}
		org_prod_cat = prod_cat_selected;
	//	console.log(org_prod_cat, prod_cat_selected)
	}
    // setTimeout(timer, speeds[USER_SPEED]);
	timer();
//	console.log(curr_nodes);
	function tick(e) {

//	console.log(curr_nodes);
	  var k = 0.03 * e.alpha;

	  // Push nodes toward their designated focus.
	  curr_nodes.forEach(function(o, i) {

		var curr_act = o.act;

        o.y += (groups[curr_act].y - o.y) * k;
        o.x += (groups[curr_act].x-width*.01 - o.x) * k ;

	  });

	  circle
	  	  .each(collide(.5))
          .style("fill", function(d) { return d.color; })
	      .attr("cx", function(d) { return d.x+10; })
	      .attr("cy", function(d) { return d.y; })
		  .style("stroke", function(d) { return d.stroke; })
		  .style("stroke-width", 4.5);


	}

		// Resolve collisions between nodes.
	function collide(alpha) {
	  var quadtree = d3.geom.quadtree(curr_nodes);
	  return function(d) {
	    var r = d.radius + maxRadius + padding,
	        nx1 = d.x - r,
	        nx2 = d.x + r,
	        ny1 = d.y - r,
	        ny2 = d.y + r;
	    quadtree.visit(function(quad, x1, y1, x2, y2) {
	      if (quad.point && (quad.point !== d)) {
	        var x = d.x - quad.point.x,
	            y = d.y - quad.point.y,
	            l = Math.sqrt(x * x + y * y),
	            r = d.radius + quad.point.radius + (d.act !== quad.point.act) * padding;
	        if (l < r) {
	          l = (l - r) / l * alpha;
	          d.x -= x *= l;
	          d.y -= y *= l;
	          quad.point.x += x;
	          quad.point.y += y;
	        }
	      }
	      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
	    });
	  };
	}

		// Speed toggle
	d3.selectAll(".togglebutton")
      .on("click", function() {
        if (d3.select(this).attr("data-val") == "pause") {
            d3.select(".pause").classed("current", true);
			d3.select(".medium").classed("current", false);
            d3.select(".fast").classed("current", false);
        } else if (d3.select(this).attr("data-val") == "medium") {
            d3.select(".pause").classed("current", false);
			d3.select(".medium").classed("current", true);
            d3.select(".fast").classed("current", false);
        } else {
            d3.select(".pause").classed("current", false);
			d3.select(".medium").classed("current", false);
			d3.select(".fast").classed("current", true);
        }

        force.resume();
        clearTimeout(simtimer);
		USER_SPEED = d3.select(this).attr("data-val");

        if (USER_SPEED != "pause") timer();
    });
}); // @end d3.tsv

function filter_reset (node)	{

	if (node.exist == 1)
	{
	if (node.color == "transparent")
	{
			groups[node.act].cnt += 1;
			member_tiers[node.member_tier].cnt += 1;
	}

	}

	if (node.leave == 1)
	{
		node.stroke = "red";
	}
	else if (node.leave == -1)
	{
		node.stroke = "green";
	}
	

	
	node.color = member_tiers[node.member_tier].color;
}

function filter_bubbles (node) {

	if (node.color != "transparent")
	{
	console.log(node.color)
	console.log(node)
		if (node.exist == 1)
		{
//		console.log(node)
//		console.log(node.color)
				groups[node.act].cnt -= 1;
				member_tiers[node.member_tier].cnt -= 1;
		}

		node.stroke = "transparent";
		node.color = "transparent";
	}

//		node.color = "transparent";
//		console.log(node.color)



	return node;
}



function get_currDateTime (d) {

	curr_time_str = d.split(" ")[1] + ":00" ;

	if (curr_time_str.length != 8)
	{
		curr_time_str = "0" + curr_time_str;
	}


	curr_time_arr = curr_time_str.split(":");

	h_temp = parseInt(curr_time_arr[0]);

	if (h_temp > 12)
	{
		hh = h_temp-12;
	}
	else hh = h_temp


//	console.log(curr_time_arr)
//	hh = curr_time_arr[0];
	mm = curr_time_arr[1];
	ss = curr_time_arr[2];
	curr_date_str = d.split(" ")[0];
	curr_date_arr = curr_date_str.split("/");
	dd = parseInt(curr_date_arr[1]);
	MM = parseInt(curr_date_arr[0]);
	yyyy = parseInt(curr_date_arr[2]);
//	console.log(curr_time_str)

	if (hh == "00")
	{
		hh = "12";
	}
//	console.log(hh,mm,ss)

	return [dd, MM, yyyy, hh, mm, ss];

}

// Minutes to time of day. Data is minutes from 4am.
function minutesToTime(s) {

	d = curr_date;

//	var seconds = s % 1440;
	var seconds = s;
//	var minutes = Math.floor(seconds / 60)

//	var hh = Math.floor(seconds/60 / 60);
	var ampm;

	var hh = Math.floor(s/3600);
//	console.log(hh)
	var mm = Math.floor(s/60) - (hh * 60);
//	console.log(mm)

	var ss = seconds % 60;
	
	

	if (hh >= 24)
	{
			if (s == 86400 && date_update == 0)
				{
					
					date_update = 1
					var date = d3.select("#current_date").text();
					date = date.split('/');
					var month = date[0];
					var year = date[2];
					var day = parseInt(date[1], 10);
					day += 1;
					if (day < 10){
						day = "0" + day;
					}
					var new_date = month + '/' + day + '/' + year;
	//				console.log(new_date);
					d3.select("#current_date").text(new_date);
					
				}
		if (hh%24 == 0)
		{
				hh = "0";
				ampm = "am";
//				console.log(mm,ss)
		

		}

	else
		hh = hh%24;
	ampm = "am"

	}
	else if (hh > 12) {
		hh = hh - 12;
		ampm = "pm";
		
	} else if (hh == 12) {
		ampm = "pm";
	} else if (hh == 0) {
		hh = 12;
		ampm = "am";
	} else {
		ampm = "am";
	}


	if (ss<10) {
		ss = "0" + ss;
	}

	if (hh<10) {
		hh = "0" + hh;
	}

//	var mm = minutes % 60;


	if (mm < 10) {
		mm = "0" + mm;
	}


	t = " " + hh + ":" + mm + ":" + ss + ampm;
	


	return [d.toString(), hh.toString(), mm.toString(), ss.toString(), ampm.toString()];
}

// For SVG text-wrapping
function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        x = text.attr("x"),
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}


</script>
